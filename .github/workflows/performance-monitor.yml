name: Performance Monitor

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      url:
        description: 'URL to test'
        required: false
        default: 'https://likhonsex.github.io/likhonsheikh.xyz'

jobs:
  build-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Analyze bundle size
        run: |
          echo "Analyzing build output..."
          if [ -d ".next/server" ]; then
            echo "Build successful!"
            du -sh out/ 2>/dev/null || echo "Checking build size..."
          fi

      - name: Count pages
        run: |
          echo "Generated pages:"
          find out/ -name "*.html" | wc -l
          echo "HTML pages generated"

  audit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Audit dependencies
        run: npm audit --audit-level=moderate
        continue-on-error: true

  dependency-outdated:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Check outdated packages
        run: |
          echo "Checking for outdated dependencies..."
          npm outdated --long=false
